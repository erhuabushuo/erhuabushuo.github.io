<!doctype html>
<html lang="cn" itemscope itemtype="http://schema.org/Person">
<head>
  <meta charset="utf-8">
  <!-- Site Meta Data -->
  <title>为什么Python如此慢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="erhuabushuo(@)gmail.com">

  <link rel="shortcut icon" href="">

  <!-- schema.org -->
  <meta itemprop="name" content="疯人院主任">
  <meta itemprop="image" content="">
  <meta itemprop="description" content="">

  <!-- Style Meta Data -->
  <link rel="stylesheet" href="/theme/css/milligram.css" type="text/css" />
  <link rel="stylesheet" href="/theme/css/custom.css" type="text/css" />

  <!-- Feed Meta Data -->

  <!-- Twitter Feed -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="">
  <meta name="twitter:image" content="">

<meta name="twitter:creator" content="">
<meta name="twitter:url" content="/wei-shi-yao-pythonru-ci-man.html">
<meta name="twitter:title" content="疯人院主任 ~ 为什么Python如此慢">
<meta name="twitter:description" content="Python当前人气暴涨。它在DevOps，数据科学，Web开发和安全领域均有使用。 但是在速度方面没有赢得美誉。 这里有关于Python比较其他语言如，Java, C#, Go, JavaScript, C++进行性能对比，其中Python是最慢的。包含了JIT(C#, Java)和AOT(C,C++)编译器，也有像解释型语言如JavaScript。 注意：文章中我所提到的&#34;Python&#34;均指使用C语言实现的CPython。 为什么要比其他语言慢到2-10x的速度？ 这是相关原因： 它的GIL（Global Interpreter Lock) 因为是解释器型非编译型 因为是动态语言 那这些原因中哪个占最大成分呢？ 它的GIL 现代计算机大多数都具备多核，有时还有多处理器。为了充分利用这些处理能力，操作系统底层提供了一个叫做线程的东西，它（例如Chrome浏览器）可以系统内容创建多个线程进行指令处理。也就是说当一个进程是CPU密集型，那就可以通过多个核协同工作来提高应用的运行速度。 我本地Chrome浏览器当前会开启44个线程，在不同的操作系统例如POSIX（Mac OS和Linux）和Windows提供的线程API结构不一样 ...">

<!-- Facebook Meta Data -->
<meta property="og:title" content="疯人院主任 ~ 为什么Python如此慢" />
<meta property="og:description" content="Python当前人气暴涨。它在DevOps，数据科学，Web开发和安全领域均有使用。 但是在速度方面没有赢得美誉。 这里有关于Python比较其他语言如，Java, C#, Go, JavaScript, C++进行性能对比，其中Python是最慢的。包含了JIT(C#, Java)和AOT(C,C++)编译器，也有像解释型语言如JavaScript。 注意：文章中我所提到的&#34;Python&#34;均指使用C语言实现的CPython。 为什么要比其他语言慢到2-10x的速度？ 这是相关原因： 它的GIL（Global Interpreter Lock) 因为是解释器型非编译型 因为是动态语言 那这些原因中哪个占最大成分呢？ 它的GIL 现代计算机大多数都具备多核，有时还有多处理器。为了充分利用这些处理能力，操作系统底层提供了一个叫做线程的东西，它（例如Chrome浏览器）可以系统内容创建多个线程进行指令处理。也就是说当一个进程是CPU密集型，那就可以通过多个核协同工作来提高应用的运行速度。 我本地Chrome浏览器当前会开启44个线程，在不同的操作系统例如POSIX（Mac OS和Linux）和Windows提供的线程API结构不一样 ..." />
<meta property="og:image" content="" />
</head>

<body>
    <div class="container">

    <!-- Navbar -->
      <div class="navbar">
        <ul>
            <div>
                <li>
                    <a href=""><h3>疯人院主任</h3></a>
                </li>
                <li>
                </li>
            </div>
        </ul>
      </div>

  <!-- Sidebar -->
    <sidebar>
        <ul class="static-item">

        </ul>        

        <ul>
                <div class="cat-border">
                <li style="color: #F2F1EF; background-color: #6C7A89;">Categories</li>
                    <li><a href="/category/bluetooth.html">Bluetooth</a></li>
                    <li><a href="/category/flask.html">Flask</a></li>
                    <li><a href="/category/programming.html">Programming</a></li>
                    <li><a href="/category/python.html">Python</a></li>
                    <li><a href="/category/sip.html">SIP</a></li>
                    <li><a href="/category/vue.html">Vue</a></li>
                </div>
        </ul>

            <h2><br/>BLOGROLLS</h2>
            <ul>
                    <li><a href="http://banshenghuo.com/">伴生活</a></li>
                    <li><a href="http://doordu.com/">多度科技</a></li>
            </ul> 
   
        <p> 
                <span>
                    <a href="mailto:erhuabushuo(at)gmail.com" target="_blank">
                        <img class="social-icons-m" src="/theme/images/icons/mail.png">
                    </a>
                </span>
                <span>
                    <a href="http://github.com/erhuabushuo" target="_blank">
                        <img class="social-icons-m" src="/theme/images/icons/github.png">
                    </a>
                </span>
        </p>
        <p>
        </p>
        <p>
        </p>
    </sidebar>
    
    <maincontent>
<h2>
    <a href="/wei-shi-yao-pythonru-ci-man.html" rel="bookmark" title="Permalink to 为什么Python如此慢">为什么Python如此慢</a>
</h2>

<div>
    <b>By: </b><a href="/author/erhuabushuogmailcom.html">erhuabushuo(@)gmail.com</a><b>    On: </b>三 12 十二月 2018<br />
    <b>In: </b><a href="/category/python.html" rel="bookmark" title="Permalink to Python">Python</a><br />
    <em><b>Tags: </b>
    </em>
    <hr>
</div>

<div>
    <mainarticle>
    <p>Python当前人气暴涨。它在DevOps，数据科学，Web开发和安全领域均有使用。</p>
<p>但是在速度方面没有赢得美誉。</p>
<p><a href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/faster/python.html">这里</a>有关于Python比较其他语言如，Java, C#, Go, JavaScript, C++进行性能对比，其中Python是最慢的。包含了JIT(C#, Java)和AOT(C,C++)编译器，也有像解释型语言如JavaScript。</p>
<p>注意：文章中我所提到的"Python"均指使用C语言实现的CPython。</p>
<p>为什么要比其他语言慢到2-10x的速度？</p>
<p>这是相关原因：</p>
<ul>
<li>它的GIL（Global Interpreter Lock)</li>
<li>因为是解释器型非编译型</li>
<li>因为是动态语言</li>
</ul>
<p>那这些原因中哪个占最大成分呢？</p>
<h2>它的GIL</h2>
<p>现代计算机大多数都具备多核，有时还有多处理器。为了充分利用这些处理能力，操作系统底层提供了一个叫做线程的东西，它（例如Chrome浏览器）可以系统内容创建多个线程进行指令处理。也就是说当一个进程是CPU密集型，那就可以通过多个核协同工作来提高应用的运行速度。</p>
<p>我本地Chrome浏览器当前会开启44个线程，在不同的操作系统例如POSIX（Mac OS和Linux）和Windows提供的线程API结构不一样。操作系统来负责线程的调度。</p>
<p>如果你之前并没有进行过多线程编程，你需要熟悉一个叫做锁的概念。不像单线程进行，你需要确保在内存改变一个变量时，多个线程不会同时进行操作。</p>
<p>CPython创建变量时，它会开辟内存，然后计算有多少引用该变量，这个概念叫做引用计数。如果引用技术为0时，它会将内存释放回给系统。这也就是创建临时变量，进行循环操作时并不会耗光内存</p>
<p>在多线程共享变量时，CPython时如何对引用计数上锁呢。这里就是“全局解释锁(global interpreter lock)”负责做的事情，不管你有多少的线程，解释器在同一个时间只能有一个线程进行操作。</p>
<h2>那么它对Python应用有什么性能影响</h2>
<p>如果应用是单解释器，单线程。在速度上没有任何影响。</p>
<p>如果你想在单解释器使用线程了实现并发操作，并且它们是IO密集型（例如网络IO或者硬盘IO），那你将会看到GIL类似如下竞争执行：</p>
<p><img alt="alt" src="https://cdn-images-1.medium.com/max/1040/0*S_iSksY5oM5H1Qf_.png" /></p>
<p>如你有一个web应用（例如Django)并且使用WSGI，每个请求将会分配到单独Python解释器，此时一个请求只有一把锁。因为Python解释器启动比较慢，一些WSGI会实现为"Daemon Mode"执行，</p>
<h2>那其他Python运行时呢</h2>
<p>PyPy实现的GIL通常要比CPython快3x倍。</p>
<p>Jython没有GIL，因为Jython的线程受益与JVM的内存管理机制。</p>
<h2>JavaScript 是怎么实现的</h2>
<p>首先，JavaScript使用的是标记清除算法实现的垃圾回收机制。而CPython需要GIL主要原因就是内存管理算法。</p>
<p>JavaScript没有GIL，但是因为它设计的就是单线程，所以它并不需要。JavaScript的event loop和Promise/Callback机制来进行异步编码实现并发。Python也有类似的asyncio的event-loop机制。</p>
<h2>因为它是解释型语言</h2>
<p>如果你在终端使用<code>python myscript.py</code>运行，CPython将会进行一系列的读取，词法分析，语法分析，编译，解释和执行代码。</p>
<p>一个非常重要点事，在编译过程中生成的.pyc文件，Python3是放置在<code>__pycache__</code>目录下，Python2是在文件相同目录下。该文件就是Python里面的字节码，在执行文件不会生成，只会在倒入的模块或者第三方模块生成。</p>
<p>所以，Python解释成字节码并且进行运行。与Java和C#.NET相比：</p>
<p>Java 编译成一个中间语言，然后JVM加载字节码，进行just in time编译成机器码。.NET CLI也是同样的方式，.NET common language runtime使用just in time编译成机器码</p>
<p>那么，Python为什么要比Java和C#测试性能差那么多，都是使用字节码，区别就在于JIT编译方式。</p>
<p>Just in time需要一个中间语言允许代码被拆为多个chunks(或者frames)，AOT编译器设计用来确保CPU能够理解里面的内容。</p>
<p>JIT本身没有提高代码执行，但是因为它执行仍然是字节码。然后，JIT允许在运行中优化执行。一个好的JIT加应用程序执行很高的代码，将字节码直接优化为机器码，从而提高执行效率，这种技术成为 Hot Spot。</p>
<p>也就是说在程序一次次执行过程中，会变得越来越快。还有就是，Java和C#是强类型语言，所以优化器能够进一步优化。</p>
<p>PyPy也有JIT，设计比CPython执行更快。</p>
<h2>那么CPython为什么不用JIT</h2>
<p>JIT也有缺点，就是减慢了启动时间。CPython启动时间已经很慢了，PyPy更是比CPython慢2-3x倍。JVM启动速度是臭的不行。.NET CLR在系统启动的时候就先启动了。</p>
<p>如果你有一个Python进程要长时间运行，那么可以使用JIT的hot spots带来的益处。</p>
<p>然而，CPython设计为通用语言。所以，当你在实现命令行应用时，每次都要长时间等待JIT启动那是非常讨厌的事情。</p>
<p>CPython也做很多尝试，也尝试性使用Plugging方式加入JIT，但是项目现在是停滞的。</p>
<h2>因为它是动态类型的</h2>
<p>在静态类型语言中，你必须在申明时就定义它的类型，这些语言有C，C++，Java，C#和Go。</p>
<p>在一个动态类型元中，虽然也有类型的概念，但是一个变量的类型是动态的</p>
<div class="highlight"><pre>a = 1
a = &quot;foo&quot;
</pre></div>


<p>在上面示例中，Python使用了相同的变量赋于了不同的str类型，它会释放第一次创建的内存。</p>
<p>静态语言并不是设计来让你编码头疼，而是为了适应CPU的操作方式。因为所有的操作都是二进制操作，你需要将所有的对象和类型转换为低级别的数据结构。</p>
<p>Python已经为了做了这件事情，你看不见也不需要关系。</p>
<p>不用申明类型并不是导致Python变慢的直接原因，这样设计让你几乎所有操作都是动态的。你可以在运行时替换对象的方法，你可以在运行时对底层系统调用进行monkey-patch操作，一切皆有可能。</p>
<p>这样的设计导致Python很难进行优化。</p>
<p>为了验证我的观点，我将在我的Ubuntu系统中使用syscall追踪工具Dtrace。CPython并不内建DTrace，所以你需要重新编译CPython，我将使用Python 3.7.0：</p>
<div class="highlight"><pre>./configure --with-dtrace
make
</pre></div>


<p>现在代码中就可以使用Dtrace进行追踪了，你可以<a href="https://github.com/paulross/dtrace-py/tree/master/toolkit">下载</a>工具来对Python的函数调用，执行时间，CPU时间，syscalls等进行分析：</p>
<div class="highlight"><pre>sudo dtrace -s toolkit/&lt;tracer&gt;.d -c ‘../cpython/python.exe script.py’
</pre></div>


<p>py_callflow追踪器打印了类似如下信息：</p>
<p><img alt="alt" src="http://thyrsi.com/t6/631/1544684962x2890171761.gif" /></p>
<p>所以，Python动态类型是否让它变慢呢</p>
<ul>
<li>对比和转换类型代价很高，每次变量读取，类型检查时都很耗时。</li>
<li>动态类型很难对语言进行优化。Python其他替代方案要快，是因为它们为达性能对灵活性做出了妥协。</li>
<li>看看Cython,将C静态类和和Python优化类型可以在84x性能提高。</li>
</ul>
<h2>结论</h2>
<p>Python主要慢的原因是因为它的动态和灵活性。它可以作为解决大多数问题的工具，也存在更优更快的可选方案。</p>
<p>可以在应用程序中利用async，理解性能工具，考虑使用多解释器等进行优化。</p>
<p>如果对于启动时间不是那么关心的话可以考虑使用JIT，例如PyPy。</p>
<p>对于性能要求比较苛刻的，你可以使用更多的静态类型变量，考虑使用Cython</p>
    </mainarticle>
</div>
<hr>
        
<div>
        <i>If you found the article helpful, please share or cite the article, and spread the word:</i>
            <p style="margin-top: 2%;">
                <span><a target="_blank" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false;" title="Twitter" href="https://twitter.com/share?url=/wei-shi-yao-pythonru-ci-man.html&text=为什么Python如此慢&via="><img class="social-icons-a" src="/theme/images/icons/twitter.png"></a></span>
                <span><a target="_blank" title="Facebook" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false;" href="https://www.facebook.com/sharer.php?u=/wei-shi-yao-pythonru-ci-man.html&t=为什么Python如此慢"><img class="social-icons-a" src="/theme/images/icons/facebook.png"></a></span>

                <a  target="_blank" title="Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=/wei-shi-yao-pythonru-ci-man.html&title=为什么Python如此慢" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;"><img class="social-icons-a" src="/theme/images/icons/linkedin.png"></a>
            </p>
</div>
<hr>
    <p><i>For any feedback or corrections, please write in to: </i><b> erhuabushuo(@)gmail.com </b></p>
        
    </maincontent>

  <!-- Analytics -->

  </div>
</body>

</html>