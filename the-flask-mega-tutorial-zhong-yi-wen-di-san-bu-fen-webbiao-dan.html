<!doctype html>
<html lang="cn" itemscope itemtype="http://schema.org/Person">
<head>
  <meta charset="utf-8">
  <!-- Site Meta Data -->
  <title>《The Flask Mega-Tutorial》中译文：第三部分、Web表单</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="erhuabushuo(@)gmail.com">

  <link rel="shortcut icon" href="">

  <!-- schema.org -->
  <meta itemprop="name" content="疯人院主任">
  <meta itemprop="image" content="">
  <meta itemprop="description" content="">

  <!-- Style Meta Data -->
  <link rel="stylesheet" href="/theme/css/milligram.css" type="text/css" />
  <link rel="stylesheet" href="/theme/css/custom.css" type="text/css" />

  <!-- Feed Meta Data -->

  <!-- Twitter Feed -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="">
  <meta name="twitter:image" content="">

<meta name="twitter:creator" content="">
<meta name="twitter:url" content="/the-flask-mega-tutorial-zhong-yi-wen-di-san-bu-fen-webbiao-dan.html">
<meta name="twitter:title" content="疯人院主任 ~ 《The Flask Mega-Tutorial》中译文：第三部分、Web表单">
<meta name="twitter:description" content="来自Miga的Flask新版系列教程，翻译水平有限，大部分按自己理解进行翻译，内容有删减. 介绍 Flask-WTF 我通过引入Flask-WTF扩展来处理我们Web应用中的表单，它是针对WTForms集成Flask的包装。这也是我第一个给你介绍的扩展，后面还有很多。Flask生态里面扩展是非常重要的部分，它们为你解决Flask核心没有提供的相关功能。 Flask扩展也是标准的Python包，也即使用pip进行安装。你现在就可以在你的虚拟环境来安装Flask-WTF了： (venv) $ pip install flask-wtf 配置 到现在因为应用程序非常简单，我并没有过多去考虑配置问题。不过在设计应用前，我们需要考虑，该怎么去组合我们的应用配置。 含有多种应用程序指定配置方式。最简单就是定义app.config字典类型键值。例如： app = Flask(__name__) app.config[&#39;SECRET_KEY&#39;] = &#39;you-will-never-guess&#39; # ... 加入更多需要配置的变量 虽然上面方式可以实现，不过我为了保持分离原则，我将配置放置独立的文件中。 我最喜欢的一个可扩展的格式是使用类来存放配置变量。为让代码更好组织 ...">

<!-- Facebook Meta Data -->
<meta property="og:title" content="疯人院主任 ~ 《The Flask Mega-Tutorial》中译文：第三部分、Web表单" />
<meta property="og:description" content="来自Miga的Flask新版系列教程，翻译水平有限，大部分按自己理解进行翻译，内容有删减. 介绍 Flask-WTF 我通过引入Flask-WTF扩展来处理我们Web应用中的表单，它是针对WTForms集成Flask的包装。这也是我第一个给你介绍的扩展，后面还有很多。Flask生态里面扩展是非常重要的部分，它们为你解决Flask核心没有提供的相关功能。 Flask扩展也是标准的Python包，也即使用pip进行安装。你现在就可以在你的虚拟环境来安装Flask-WTF了： (venv) $ pip install flask-wtf 配置 到现在因为应用程序非常简单，我并没有过多去考虑配置问题。不过在设计应用前，我们需要考虑，该怎么去组合我们的应用配置。 含有多种应用程序指定配置方式。最简单就是定义app.config字典类型键值。例如： app = Flask(__name__) app.config[&#39;SECRET_KEY&#39;] = &#39;you-will-never-guess&#39; # ... 加入更多需要配置的变量 虽然上面方式可以实现，不过我为了保持分离原则，我将配置放置独立的文件中。 我最喜欢的一个可扩展的格式是使用类来存放配置变量。为让代码更好组织 ..." />
<meta property="og:image" content="" />
</head>

<body>
    <div class="container">

    <!-- Navbar -->
      <div class="navbar">
        <ul>
            <div>
                <li>
                    <a href=""><h3>疯人院主任</h3></a>
                </li>
                <li>
                </li>
            </div>
        </ul>
      </div>

  <!-- Sidebar -->
    <sidebar>
        <ul class="static-item">

        </ul>        

        <ul>
                <div class="cat-border">
                <li style="color: #F2F1EF; background-color: #6C7A89;">Categories</li>
                    <li><a href="/category/bluetooth.html">Bluetooth</a></li>
                    <li><a href="/category/flask.html">Flask</a></li>
                    <li><a href="/category/programming.html">Programming</a></li>
                    <li><a href="/category/python.html">Python</a></li>
                    <li><a href="/category/sip.html">SIP</a></li>
                    <li><a href="/category/vue.html">Vue</a></li>
                </div>
        </ul>

            <h2><br/>BLOGROLLS</h2>
            <ul>
                    <li><a href="http://banshenghuo.com/">伴生活</a></li>
                    <li><a href="http://doordu.com/">多度科技</a></li>
            </ul> 
   
        <p> 
                <span>
                    <a href="mailto:erhuabushuo(at)gmail.com" target="_blank">
                        <img class="social-icons-m" src="/theme/images/icons/mail.png">
                    </a>
                </span>
                <span>
                    <a href="http://github.com/erhuabushuo" target="_blank">
                        <img class="social-icons-m" src="/theme/images/icons/github.png">
                    </a>
                </span>
        </p>
        <p>
        </p>
        <p>
        </p>
    </sidebar>
    
    <maincontent>
<h2>
    <a href="/the-flask-mega-tutorial-zhong-yi-wen-di-san-bu-fen-webbiao-dan.html" rel="bookmark" title="Permalink to 《The Flask Mega-Tutorial》中译文：第三部分、Web表单">《The Flask Mega-Tutorial》中译文：第三部分、Web表单</a>
</h2>

<div>
    <b>By: </b><a href="/author/erhuabushuogmailcom.html">erhuabushuo(@)gmail.com</a><b>    On: </b>二 27 三月 2018<br />
    <b>In: </b><a href="/category/flask.html" rel="bookmark" title="Permalink to Flask">Flask</a><br />
    <em><b>Tags: </b>
    </em>
    <hr>
</div>

<div>
    <mainarticle>
    <p>来自Miga的Flask新版系列教程，翻译水平有限，大部分按自己理解进行翻译，内容有删减.</p>
<h2>介绍 Flask-WTF</h2>
<p>我通过引入<a href="http://packages.python.org/Flask-WTF">Flask-WTF</a>扩展来处理我们Web应用中的表单，它是针对<a href="https://wtforms.readthedocs.io/">WTForms</a>集成Flask的包装。这也是我第一个给你介绍的扩展，后面还有很多。Flask生态里面扩展是非常重要的部分，它们为你解决Flask核心没有提供的相关功能。</p>
<p>Flask扩展也是标准的Python包，也即使用<code>pip</code>进行安装。你现在就可以在你的虚拟环境来安装Flask-WTF了：</p>
<div class="highlight"><pre>(venv) $ pip install flask-wtf
</pre></div>


<h2>配置</h2>
<p>到现在因为应用程序非常简单，我并没有过多去考虑配置问题。不过在设计应用前，我们需要考虑，该怎么去组合我们的应用配置。</p>
<p>含有多种应用程序指定配置方式。最简单就是定义<strong>app.config</strong>字典类型键值。例如：</p>
<div class="highlight"><pre>app = Flask(__name__)
app.config[&#39;SECRET_KEY&#39;] = &#39;you-will-never-guess&#39;
# ... 加入更多需要配置的变量
</pre></div>


<p>虽然上面方式可以实现，不过我为了保持分离原则，我将配置放置独立的文件中。</p>
<p>我最喜欢的一个可扩展的格式是使用类来存放配置变量。为让代码更好组织，我将在独立Python模块中创建配置类。在顶级目录中创建config.py文件来存放如下新的配置类：</p>
<p><strong>config.py</strong></p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>

<span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
    <span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;SECRET_KEY&#39;</span><span class="p">,</span> <span class="s">&#39;you-will-never-guess&#39;</span><span class="p">)</span>
</pre></div>


<p>是不是很简单？我们把配置参数配置为<strong>Config</strong>类变量。当需要更多配置项时，我们就可以添加到该类了，如果我们需要更多的配置集的话我们就可以通过创建子类来实现，现在暂时先抛开它。</p>
<p>这里唯一加入的<strong>SECRET_KEY</strong>配置项在Flask应用中具有特殊功能，Flask和一些扩展使用该职作为加密密钥，用来生成签名或者Tokens。Flask-WTF使用它来防止<a href="http://en.wikipedia.org/wiki/Cross-site_request_forgery">CSRF</a>，所以记得不要泄露该密钥。</p>
<p>我们这里使用环境变量方式来赋予SECRET_KEY，当然如果环境变量没有设置的话会使用传入的默认值。这在一些实践中推荐这么做，将一些敏感信息从文件编码中隔离的环境变量中。</p>
<p>现在我们有了配置文件，我需要告诉Flask加载它。Flask应用使用<strong>app.config.from_object()</strong>方法实现：</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">Config</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">Config</span><span class="p">)</span>


<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">routes</span>
</pre></div>


<p>我们之前有提高，可以通过类似访问字典的方式来读取app.config配置项目,因为它继承自dict类。以下是获取配置的密钥方法：</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">microblog</span> <span class="kn">import</span> <span class="n">app</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SECRET_KEY&#39;</span><span class="p">]</span>
<span class="s">&#39;you-will-never-guess</span>
</pre></div>


<h2>用户登陆表单</h2>
<p>Flask-WTF扩展通过使用Python类来呈现表单。在表单类里通过定义类成员变量来对应表单字段。</p>
<p>同样我还是坚持分离原则，我将使用一个新文件app/forms.py来存储我们的web表单类。我们从实现一个用户登陆表单开始，给予访问者输入用户名和密码。表单还存有一个“记住我”复选框，还有一个提交按钮。</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">FlaskForm</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">PasswordField</span><span class="p">,</span> <span class="n">BooleanField</span><span class="p">,</span> <span class="n">SubmitField</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span>


<span class="k">class</span> <span class="nc">LoginForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">&#39;帐号&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="s">&#39;帐号是必填的项&#39;</span><span class="p">)])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="s">&#39;密码&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="s">&#39;密码是必填的项&#39;</span><span class="p">)])</span>
    <span class="n">remember_me</span> <span class="o">=</span> <span class="n">BooleanField</span><span class="p">(</span><span class="s">&#39;记住我&#39;</span><span class="p">)</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="s">&#39;登陆&#39;</span><span class="p">)</span>
</pre></div>


<p>大部分Flask扩展都是用flask_<name>来命名包名。这里，Flask-WTF命名为<strong>flask_wtf</strong>。这里我们导入了一个<strong>FlaskForm</strong>作为基类。</p>
<p>虽然引入的四个类是不同的字段类型，由于Flask-WTF扩展没有另外定义在自身命名空间下，所以我们需要直接从wtforms包中导入，每个字段定义为<strong>LoginForm</strong>类成员变量，传递的第一参数为字段标签名。</p>
<p>可选的<strong>validators</strong>参数可以赋予字段验证行为。<strong>DataRequired</strong>用来检查字段是否为空值。还有很多可用的验证起，有一些我们将在后面定义的表单中使用。</p>
<h2>表单模板</h2>
<p>接下来我们需要给我们的表单加入HTML模板来呈现Web页面。好消息是<strong>LoginForm</strong>类知道怎么样呈现它自己为HTML，所以这个工作非常简单。以下我们创建app/templates/login.html来构建模板：</p>
<p><strong>app/templates/login.html</strong></p>
<div class="highlight"><pre><span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;base.html&quot;</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
    <span class="nt">&lt;h1&gt;</span>登陆<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
        <span class="cp">{{</span> <span class="nv">form.hidden_tag</span><span class="o">()</span> <span class="cp">}}</span>
        <span class="nt">&lt;p&gt;</span>
            <span class="cp">{{</span> <span class="nv">form.username.label</span> <span class="cp">}}</span><span class="nt">&lt;br&gt;</span>
            <span class="cp">{{</span> <span class="nv">form.username</span><span class="o">(</span><span class="nv">size</span><span class="o">=</span><span class="m">32</span><span class="o">)</span> <span class="cp">}}</span>
        <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>
            <span class="cp">{{</span> <span class="nv">form.password.label</span> <span class="cp">}}</span><span class="nt">&lt;br&gt;</span>
            <span class="cp">{{</span> <span class="nv">form.password</span><span class="o">(</span><span class="nv">size</span><span class="o">=</span><span class="m">32</span><span class="o">)</span> <span class="cp">}}</span>
        <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span><span class="cp">{{</span> <span class="nv">form.remember_me</span><span class="o">()</span> <span class="cp">}}</span> <span class="cp">{{</span> <span class="nv">form.remember_me.label</span> <span class="cp">}}</span><span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span><span class="cp">{{</span> <span class="nv">form.submit</span><span class="o">()</span> <span class="cp">}}</span><span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>


<p>这里我们通过<strong>extend</strong>（继承）重用<strong>base.html</strong>模板。基本上我在所有后面的模板都会这么做，为确保应用中所有的页面都包含顶部的导航。</p>
<p>该模板需要一个<strong>LoginForm</strong>类的表单对象form，我们会在视图函数中进行传递。</p>
<p><strong>form.hidden_tag()</strong>用来生成表单中的隐藏域，还包含用于防止CSRF攻击的token。你要做的就是应用中配置<strong>SECRET_KEY</strong>变量然后在表单中引入该隐藏域，其他的就交给Flask-WTF。</p>
<p>如果你之前有过手写表单的经历，你可能会看到这些标记该单奇怪，其实这里form对象知道帮你做了转换成相应HTML的工作。通过使用{{ form.<field_name>.label }}来引用字段标签，通过使用 {{ form.<field_name>() }}来引用表单域。如果你还需要附加HTML属性的话，还可以作为参数传递。例如这里用户名和密码域就传递了<strong>size</strong>作为参数附件到了<input>HTML元素属性。同样你可以赋予CSS类或ID。</p>
<h2>表单视图</h2>
<p>在实现可在浏览器看到我们的表单最后步之前，我们还需要创建一个新的视图函数来呈现我们的模板。</p>
<p>那么，让我们创建一个映射到/login URL的视图函数，它创建表单，并且把表单传递给了模板。该视图函数定义在app/routes.py模块。</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>

<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span> <span class="nn">app.forms</span> <span class="kn">import</span> <span class="n">LoginForm</span>

<span class="c"># ...</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/login&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;login.html&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;登陆&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>


<p>这里我从forms.py导入了LoginForm类，实例化后传递给了模板。</p>
<p>我们在base模板加入链接提供访问用户登陆表单路径。</p>
<div class="highlight"><pre><span class="nt">&lt;div&gt;</span>Microblog: 
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/index&quot;</span><span class="nt">&gt;</span>首页<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/login&quot;</span><span class="nt">&gt;</span>登陆<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>


<p>此刻你可以跑起应用然后在浏览器看到你的表单了。</p>
<p><img alt="alt" src="https://blog.miguelgrinberg.com/static/images/mega-tutorial/ch03-login-form.png" /></p>
<h2>从表单获取数据</h2>
<p>如果你尝试去点击提交按钮，浏览器将显示"Method Not Allowed"错误。这是因为我们视图函数里的路由映射除非指定，否则默认地址映射只支持GET动作。我们先简单对视图函数做一些修改，仅验证用户提交数据：</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">redirect</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">f</span><span class="s">&quot;Login requested for user {form.username.data}, remember_me={form.remember_me.data}&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/index&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;login.html&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;登陆&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>


<p>首先要说的就是在route装饰器里面我们传入的methods参数，这里就是告诉Flask我们视图函数可以接收GET和POST请求，如果不指定默认就仅支持GET请求了。</p>
<p><strong>from.validate_on_submit()</strong>方法用来确保表单里的验证器是否都验证通过，如果是GET请求的话这里直接返回False，只要有一项验证器没有通过这里同样会返回False，后面我会告诉你如何在验证失败时加入错误提示。</p>
<p>如果这里验证通过了这里简单将会调用flash()这个常用来显示信息给用户的函数，这里我们将表单的信息直接输出。</p>
<p>第二个函数是redirect()。这个函数也即重定向函数，将用户浏览器自动挑战到给定参数的地址。</p>
<p>这里我们执行的flash()函数并没有在页面中显示出来，我们需要在应用程序模板里定义如何输出该内容。我将在base模板来加入这些信息，这样所有的模板都能得到继承。下面是更新后的基础模板：</p>
<div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;UTF-8&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;X-UA-Compatible&quot;</span> <span class="na">content=</span><span class="s">&quot;ie=edge&quot;</span><span class="nt">&gt;</span>
    <span class="cp">{%</span> <span class="k">if</span> <span class="nv">title</span> <span class="cp">%}</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">{{</span> <span class="nv">title</span> <span class="cp">}}</span> - Microblog<span class="nt">&lt;/title&gt;</span>
    <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
    <span class="nt">&lt;title&gt;</span>Welcome to microblog<span class="nt">&lt;/title&gt;</span>
    <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div&gt;</span>Microblog: 
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/index&quot;</span><span class="nt">&gt;</span>首页<span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/login&quot;</span><span class="nt">&gt;</span>登陆<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;hr&gt;</span>
    <span class="cp">{%</span> <span class="k">with</span> <span class="nv">messages</span> <span class="o">=</span> <span class="nv">get_flashed_messages</span><span class="o">()</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">if</span> <span class="nv">messages</span> <span class="cp">%}</span>
    <span class="nt">&lt;ul&gt;</span>
        <span class="cp">{%</span> <span class="k">for</span> <span class="nv">message</span> <span class="k">in</span> <span class="nv">messages</span> <span class="cp">%}</span>
        <span class="nt">&lt;li&gt;</span><span class="cp">{{</span> <span class="nv">message</span> <span class="cp">}}</span><span class="nt">&lt;/li&gt;</span>
        <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
    <span class="nt">&lt;/ul&gt;</span>
    <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">endwith</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>


<p>这里使用了with语句，用来赋予执行get_flashed_messages()函数返回的值给了messages变量，在语句块内作用域有效。Flask提供的get_flashed_messages()函数返回的是应用执行了flash()函数的列表，我们先是判断messages是否有内容，如果有的话我们使用循环遍历在无须列表内项。</p>
<p>一个有趣的特性是，get_flashed_message()函数获取的列表将会从消息列表内溢出，也就是说flash()函数传递的消息内容只会执行显示一次。</p>
<p>我们现在可以再一次尝试启动应用，测试看看表单是如何工作的。尝试提交了空用户名或者密码，看看DataRequired验证器是怎么阻止表单提交处理的。</p>
<h2>改善字段验证</h2>
<p>赋予字段的验证会在无效数据时组织表单处理。最好的处理方式是重新渲染表单然后通知用户纠正哪些有误的字段。</p>
<p>如果你现在提交表单，输入无效数据表单也不会有任何异常出现，直接重新渲染。接下来我们就来改善用户体验，增加相应的错误信息提示。</p>
<p>事实上，表单验证器已经恶搞i我们生成了错误，我们仅加入适当的逻辑来在模板中渲染。</p>
<p>下面我们就给用户名和密码字段加入错误验证信息：</p>
<div class="highlight"><pre><span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;base.html&quot;</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
    <span class="nt">&lt;h1&gt;</span>登陆<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
        <span class="cp">{{</span> <span class="nv">form.hidden_tag</span><span class="o">()</span> <span class="cp">}}</span>
        <span class="nt">&lt;p&gt;</span>
            <span class="cp">{{</span> <span class="nv">form.username.label</span> <span class="cp">}}</span><span class="nt">&lt;br&gt;</span>
            <span class="cp">{{</span> <span class="nv">form.username</span><span class="o">(</span><span class="nv">size</span><span class="o">=</span><span class="m">32</span><span class="o">)</span> <span class="cp">}}</span>
            <span class="cp">{%</span> <span class="k">for</span> <span class="nv">error</span> <span class="k">in</span> <span class="nv">form.username.errors</span> <span class="cp">%}</span>
            <span class="nt">&lt;span</span> <span class="na">style=</span><span class="s">&quot;color:red;&quot;</span><span class="nt">&gt;</span>[<span class="cp">{{</span> <span class="nv">error</span> <span class="cp">}}</span>]<span class="nt">&lt;/span&gt;</span>
            <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
        <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>
            <span class="cp">{{</span> <span class="nv">form.password.label</span> <span class="cp">}}</span><span class="nt">&lt;br&gt;</span>
            <span class="cp">{{</span> <span class="nv">form.password</span><span class="o">(</span><span class="nv">size</span><span class="o">=</span><span class="m">32</span><span class="o">)</span> <span class="cp">}}</span>
            <span class="cp">{%</span> <span class="k">for</span> <span class="nv">error</span> <span class="k">in</span> <span class="nv">form.password.errors</span> <span class="cp">%}</span>
            <span class="nt">&lt;span</span> <span class="na">style=</span><span class="s">&quot;color:red;&quot;</span><span class="nt">&gt;</span>[<span class="cp">{{</span> <span class="nv">error</span> <span class="cp">}}</span>]<span class="nt">&lt;/span&gt;</span>
            <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
        <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span><span class="cp">{{</span> <span class="nv">form.remember_me</span><span class="o">()</span> <span class="cp">}}</span> <span class="cp">{{</span> <span class="nv">form.remember_me.label</span> <span class="cp">}}</span><span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span><span class="cp">{{</span> <span class="nv">form.submit</span><span class="o">()</span> <span class="cp">}}</span><span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>


<p>这里唯一的改变是我们在字段后面加入一个循环遍历字段错误消息，并且用红色显示。按约定，任何字段如果出发了验证器失败都会将错误信息添加到form.<field_name>.error列表里。</p>
<p>如果你尝试不填入用户名和密码，那将会获得类似如下错误信息提示：</p>
<p><img alt="alt" src="https://blog.miguelgrinberg.com/static/images/mega-tutorial/ch03-validation.png" /></p>
<h2>生成链接</h2>
<p>登陆表单就快完成了，但是在结束前，我还想谈谈关于在模板中生成链接以及重定向的正确姿势。目前在基础模板链接地址是这个样子的：</p>
<div class="highlight"><pre>    <span class="nt">&lt;div&gt;</span>
        Microblog:
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/index&quot;</span><span class="nt">&gt;</span>Home<span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/login&quot;</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
</pre></div>


<p>登陆视图函数里面传递个redirect()函数的地址是这个样子的：</p>
<div class="highlight"><pre>@app.route(&#39;/login&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])
def login():
    form = LoginForm()
    if form.validate_on_submit():
        # ...
        return redirect(&#39;/index&#39;)
    # ...
</pre></div>


<p>这种方式书写地址的问题是，如果有一些你突然想重新组织你的链接，那么你不得不去查询到所有相应要更该的地址。</p>
<p>为了更好的控制这些地址，Flask提供了一个叫做url_for()函数，通过指定映射的视图函数来生成绑定的URL。例如url_for('login')返回/login，url_for('index')返回/index。url_for()函数接收的参数为函数名字。</p>
<p>你可能会疑惑为什么会要使用这样的方式。事实上，URL的变更要远高于视图函数变。还有一个原因是有些URL依赖一些动态内容生成。所以手动操作的话就需要把多部分拼接了，糟糕且容易出错。url_for()却能轻易的生成这些复杂的URL。</p>
<p>所以，从现在起我都会用url_for()来为我们生成应用程序URL。如下基础模板里导航栏的地址变为：</p>
<div class="highlight"><pre><span class="nt">&lt;div&gt;</span>Microblog: 
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">url_for</span><span class="o">(</span><span class="s1">&#39;index&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="nt">&gt;</span>首页<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">url_for</span><span class="o">(</span><span class="s1">&#39;login&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="nt">&gt;</span>登陆<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>


<p>然后我们login()视图函数更新为：</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>

<span class="c"># ...</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="c"># ...</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
    <span class="c"># ...</span>
</pre></div>
    </mainarticle>
</div>
<hr>
        
<div>
        <i>If you found the article helpful, please share or cite the article, and spread the word:</i>
            <p style="margin-top: 2%;">
                <span><a target="_blank" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false;" title="Twitter" href="https://twitter.com/share?url=/the-flask-mega-tutorial-zhong-yi-wen-di-san-bu-fen-webbiao-dan.html&text=《The Flask Mega-Tutorial》中译文：第三部分、Web表单&via="><img class="social-icons-a" src="/theme/images/icons/twitter.png"></a></span>
                <span><a target="_blank" title="Facebook" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false;" href="https://www.facebook.com/sharer.php?u=/the-flask-mega-tutorial-zhong-yi-wen-di-san-bu-fen-webbiao-dan.html&t=《The Flask Mega-Tutorial》中译文：第三部分、Web表单"><img class="social-icons-a" src="/theme/images/icons/facebook.png"></a></span>

                <a  target="_blank" title="Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=/the-flask-mega-tutorial-zhong-yi-wen-di-san-bu-fen-webbiao-dan.html&title=《The Flask Mega-Tutorial》中译文：第三部分、Web表单" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;"><img class="social-icons-a" src="/theme/images/icons/linkedin.png"></a>
            </p>
</div>
<hr>
    <p><i>For any feedback or corrections, please write in to: </i><b> erhuabushuo(@)gmail.com </b></p>
        
    </maincontent>

  <!-- Analytics -->

  </div>
</body>

</html>